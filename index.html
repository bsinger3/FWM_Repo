<!doctype html>
<html>
  <head>
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-98WRHGEPZG"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-98WRHGEPZG");
    </script>
    <title>
      FriendsWithMeasurements ‚Ä¢ Find looks that match your measurements
    </title>
    <meta
      name="description"
      content="Search real product photos by height and weight to find looks from people built like you."
    />

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body {
        font-family: system-ui, Arial, sans-serif;
        margin: 0;
        display: flex;
        min-height: 100vh;
      }
      .sidebar {
        width: 280px;
        background: #f8f8f8;
        border-right: 1px solid #ddd;
        padding: 20px;
        box-sizing: border-box;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
        transition: transform 0.3s ease;
      }
      .sidebar.collapsed {
        transform: translateX(-280px);
      }
      .sidebar h1 {
        margin: 0 0 20px;
        font-size: 20px;
      }
      .toggle-btn {
        position: fixed;
        left: 220px;
        top: 7px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 8px 12px;
        cursor: pointer;
        z-index: 100;
        transition: left 0.3s ease;
        font-size: 18px;
        line-height: 1;
        opacity: 1;
        color: #333;
      }
      .toggle-btn.collapsed {
        left: 20px;
      }
      .toggle-btn:hover {
        background: #f0f0f0;
      }
      .main-content {
        margin-left: 280px;
        padding: 20px;
        flex: 1;
        transition: margin-left 0.3s ease;
        height: 100vh;
        overflow-y: auto;
        box-sizing: border-box;
      }
      .main-content.expanded {
        margin-left: 0;
      }
      form {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .height-group {
        display: flex;
        gap: 8px;
      }
      .height-group label {
        flex: 1;
      }
      label {
        display: flex;
        flex-direction: column;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 4px;
      }
      input,
      button {
        padding: 8px;
        font-size: 14px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-top: 4px;
      }
      button {
        background: #111;
        color: #fff;
        cursor: pointer;
        border: none;
        margin-top: 8px;
      }
      button:hover {
        background: #333;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 12px;
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        text-decoration: none;
        color: #111;
        background: #fff;
      }
      .card img {
        width: 100%;
        aspect-ratio: 3/4;
        object-fit: cover;
        background: #f3f3f3;
      }
      .meta {
        padding: 8px;
        font-size: 12px;
        color: #333;
        line-height: 1.4;
      }
    </style>
  </head>
  <body>
    <button class="toggle-btn" id="toggle">‚Üê</button>

    <div class="sidebar" id="sidebar">
      <h1>Friends With Measurements</h1>
      <p
        style="font-size: 13px; color: #666; margin: 0 0 20px; line-height: 1.5"
      >
        Search real product photos from people with your exact measurements.
        Find clothing that actually fits by browsing looks from shoppers with
        similar height, weight, bust, and hips.
      </p>

      <form id="f">
        <div class="height-group">
          <label>
            Feet
            <input id="h-ft" type="number" min="4" max="7" step="1" />
          </label>
          <label>
            Inches
            <input id="h-in" type="number" min="0" max="11" step="1" />
          </label>
        </div>
        <label>
          Weight lb
          <input id="w" type="number" min="70" max="400" step="1" />
        </label>
        <label>
          Bust in
          <input id="b" type="number" min="20" max="60" step="0.5" />
        </label>
        <label>
          Hips in
          <input id="p" type="number" min="20" max="70" step="0.5" />
        </label>
        <label>
          Clothing Type
          <select id="clothing-type">
            <option value="">All Types</option>
          </select>
        </label>
        <button type="submit">Search</button>
      </form>

      <p style="font-size: 12px; color: #666; margin-top: 20px">
        <a href="/about.html" style="color: inherit">About</a> ‚Ä¢
        <a href="/privacy.html" style="color: inherit">Privacy</a> ‚Ä¢
        <a href="/terms.html" style="color: inherit">Terms</a>
      </p>
    </div>

    <div class="main-content" id="main">
      <div id="out" class="grid"></div>
    </div>

    <script src="./config.js"></script>
    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
      const sb = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
      function getOrCreateAnonId() {
        let id = localStorage.getItem("fwm_anon_id");
        if (!id) {
          id = crypto.randomUUID();
          localStorage.setItem("fwm_anon_id", id);
        }
        return id;
      }

      const FWM_ANON_ID = getOrCreateAnonId();
      function getOrCreateSessionId() {
        let id = sessionStorage.getItem("fwm_session_id");
        if (!id) {
          id = crypto.randomUUID();
          sessionStorage.setItem("fwm_session_id", id);
        }
        return id;
      }

      const FWM_SESSION_ID = getOrCreateSessionId();

      function getUtmParams() {
        const p = new URLSearchParams(window.location.search);
        const utm = {
          utm_source: p.get("utm_source"),
          utm_medium: p.get("utm_medium"),
          utm_campaign: p.get("utm_campaign"),
          utm_content: p.get("utm_content"),
        };

        // If no UTMs in the current URL, try the last saved ones
        if (!utm.utm_source && sessionStorage.getItem("fwm_utm_source")) {
          return {
            utm_source: sessionStorage.getItem("fwm_utm_source"),
            utm_medium: sessionStorage.getItem("fwm_utm_medium"),
            utm_campaign: sessionStorage.getItem("fwm_utm_campaign"),
            utm_content: sessionStorage.getItem("fwm_utm_content"),
          };
        }

        // Save UTMs for the rest of this tab session
        sessionStorage.setItem("fwm_utm_source", utm.utm_source || "");
        sessionStorage.setItem("fwm_utm_medium", utm.utm_medium || "");
        sessionStorage.setItem("fwm_utm_campaign", utm.utm_campaign || "");
        sessionStorage.setItem("fwm_utm_content", utm.utm_content || "");

        return utm;
      }

      const FWM_UTM = getUtmParams();

      const f = document.getElementById("f");
      const out = document.getElementById("out");
      const sidebar = document.getElementById("sidebar");
      const toggleBtn = document.getElementById("toggle");
      const mainContent = document.getElementById("main");

      let currentSearchParams = null;
      let currentSearchEventId = null;
      let currentOffset = 0;
      let isLoading = false;
      let hasMore = true;

      // Load clothing types
      async function loadClothingTypes() {
        const { data, error } = await sb
          .from("clothing_types")
          .select("id, label, sort_order")
          .order("sort_order", { ascending: true });

        if (!error && data) {
          const select = document.getElementById("clothing-type");
          data.forEach((ct) => {
            const option = document.createElement("option");
            option.value = ct.id;
            option.textContent = ct.label;
            select.appendChild(option);
          });
        }
      }

      loadClothingTypes();

      // Toggle sidebar
      toggleBtn.addEventListener("click", () => {
        sidebar.classList.toggle("collapsed");
        toggleBtn.classList.toggle("collapsed");
        mainContent.classList.toggle("expanded");

        // Update button icon
        if (sidebar.classList.contains("collapsed")) {
          toggleBtn.textContent = "üîç";
        } else {
          toggleBtn.textContent = "‚Üê";
        }
      });

      // Load random results on initial page load
      async function loadRandomResults() {
        isLoading = true;
        out.textContent = "Loading...";

        console.log("Loading random results...");

        const { data, error } = await sb
          .from("images")
          .select(
            "id, original_url_display, product_page_url_display, monetized_product_url_display, brand, source_site_display, height_in_display, weight_display_display, size_ordered_raw_display, color_ordered_raw_display, bust_in_display",
          )
          .not("original_url_display", "is", null)
          .not("size_ordered_raw_display", "is", null)
          .neq("size_ordered_raw_display", "")
          .or(
            "height_in_display.not.is.null,weight_display_display.not.is.null,bust_in_display.not.is.null",
          )
          .limit(24);

        console.log("Random results data:", data);
        console.log("Random results error:", error);

        if (error) {
          out.textContent = "Error loading images: " + error.message;
          console.error("Error:", error);
          isLoading = false;
          return;
        }

        if (data && data.length > 0) {
          render(data);
        } else {
          out.textContent = "No images available";
        }

        isLoading = false;
      }

      // Load random results when page loads
      loadRandomResults();

      // Infinite scroll
      mainContent.addEventListener("scroll", async () => {
        if (isLoading || !hasMore || !currentSearchParams) return;

        const scrollTop = mainContent.scrollTop;
        const scrollHeight = mainContent.scrollHeight;
        const clientHeight = mainContent.clientHeight;

        // Load more when user is 500px from bottom
        if (scrollTop + clientHeight >= scrollHeight - 500) {
          await loadMore();
        }
      });

      function parseUtmFromStorage() {
        return {
          utm_source: sessionStorage.getItem("fwm_utm_source") || null,
          utm_medium: sessionStorage.getItem("fwm_utm_medium") || null,
          utm_campaign: sessionStorage.getItem("fwm_utm_campaign") || null,
          utm_content: sessionStorage.getItem("fwm_utm_content") || null,
        };
      }
      f.addEventListener("submit", async (e) => {
        e.preventDefault();
        console.log("SUBMIT HANDLER FIRED");

        // Calculate total height in inches from feet and inches
        const feetVal = num(document.getElementById("h-ft").value);
        const inchesVal = num(document.getElementById("h-in").value);
        const totalHeightInches = (feetVal || 0) * 12 + (inchesVal || 0);

        currentSearchParams = {
          in_height: totalHeightInches > 0 ? totalHeightInches : null,
          in_weight: num(document.getElementById("w").value),
          in_bust: num(document.getElementById("b").value),
          in_hips: num(document.getElementById("p").value),
        };
        const utm = parseUtmFromStorage();

        const searchEventId = crypto.randomUUID();
        currentSearchEventId = searchEventId;

        const { error } = await sb.from("search_events").insert({
          id: searchEventId,

          anon_id: FWM_ANON_ID,
          session_id: FWM_SESSION_ID,

          page_url: window.location.href,
          referrer: document.referrer || null,

          utm_source: utm.utm_source,
          utm_medium: utm.utm_medium,
          utm_campaign: utm.utm_campaign,
          utm_content: utm.utm_content,

          feet: feetVal || null,
          inches: inchesVal || null,
          weight_lb: currentSearchParams.in_weight || null,
          bust_in: currentSearchParams.in_bust || null,
          hips_in: currentSearchParams.in_hips || null,
          clothing_type:
            document.getElementById("clothing-type")?.value || null,

          results_count: null,
          latency_ms: null,
        });

        console.log("search_events id", currentSearchEventId);
        if (error) console.error("search_events insert error", error);
        console.log("AFTER INSERT", { currentSearchEventId });

        const clothingTypeId = document.getElementById("clothing-type").value;
        if (clothingTypeId) {
          currentSearchParams.in_clothing_type_id = clothingTypeId;
        }

        // Reset for new search
        currentOffset = 0;
        hasMore = true;
        out.innerHTML = "";

        await loadMore();
      });

      async function loadMore() {
        if (isLoading || !hasMore) return;

        isLoading = true;

        // Show loading indicator
        const loadingDiv = document.createElement("div");
        loadingDiv.textContent = "Loading...";
        loadingDiv.style.gridColumn = "1 / -1";
        loadingDiv.style.textAlign = "center";
        loadingDiv.style.padding = "20px";
        loadingDiv.id = "loading-indicator";
        out.appendChild(loadingDiv);

        const body = {
          ...currentSearchParams,
          limit_n: 24,
          offset_n: currentOffset,
        };

        console.log("Request body:", body);

        const searchStart = performance.now();
        const { data, error } = await sb.rpc("match_by_measurements", body);
        const latencyMs = Math.round(performance.now() - searchStart);

        // Remove loading indicator
        const indicator = document.getElementById("loading-indicator");
        if (indicator) indicator.remove();

        console.log("Response data:", data);
        console.log("Response error:", error);

        if (currentSearchEventId) {
          const resultsCount = Array.isArray(data) ? data.length : 0;

          const payload = {
            results_count: resultsCount,
            latency_ms: latencyMs,
          };

          console.log("UPDATING SEARCH EVENT", {
            currentSearchEventId,
            payload,
          });

          const { error: updErr } = await sb
            .from("search_events")
            .update(payload)
            .eq("id", currentSearchEventId);

          if (updErr) console.error("search_events update error", updErr);
        }

        if (error) {
          out.textContent = "Error: " + error.message;
          console.error("API Error:", error);
          isLoading = false;
          return;
        }

        if (!data || data.length === 0) {
          hasMore = false;
          if (currentOffset === 0) {
            out.textContent = "No matches";
          }
        } else {
          render(data, true); // true = append mode
          currentOffset += data.length;
          if (data.length < 24) {
            hasMore = false;
          }
        }

        isLoading = false;
      }

      function render(rows, append = false) {
        if (!append) {
          out.innerHTML = "";
        }
        if (!rows || rows.length === 0) {
          if (!append) {
            out.textContent = "No matches";
          }
          return;
        }
        for (const r of rows) {
          const a = document.createElement("a");
          a.className = "card";
          a.href =
            r.monetized_product_url_display ||
            r.product_page_url_display ||
            r.original_url_display;

          a.target = "_blank";

          const img = document.createElement("img");
          img.loading = "lazy";
          img.referrerPolicy = "no-referrer";

          const proxied = window.IMAGE_PROXY
            ? window.IMAGE_PROXY + encodeURIComponent(r.original_url_display)
            : null;

          img.src = proxied || r.original_url_display;

          img.onerror = () => {
            if (proxied && img.src === proxied && r.original_url_display) {
              img.src = r.original_url_display;
              return;
            }
            img.style.display = "none";
          };

          const meta = document.createElement("div");
          meta.className = "meta";
          const metaParts = [];
          if (r.height_in_display) {
            const h = Number(r.height_in_display);
            const feet = Math.floor(h / 12);
            const inches = Math.round(h % 12);
            metaParts.push(`${feet}'${inches}"`);
          }
          if (r.weight_display_display)
            metaParts.push(r.weight_display_display);
          if (r.size_ordered_raw_display)
            metaParts.push(r.size_ordered_raw_display);
          if (r.color_ordered_raw_display)
            metaParts.push(r.color_ordered_raw_display);

          meta.textContent = metaParts.join("  ¬∑  ");

          a.appendChild(img);
          a.appendChild(meta);
          out.appendChild(a);
        }
      }

      function num(v) {
        if (v === "" || v === null || v === undefined) return null;
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
      }
    </script>
  </body>
</html>
